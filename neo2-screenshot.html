<!doctype html>
<html lang="ja">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>画面共有 → スクショ → 送信</title>
<style>
  body{font-family:system-ui, -apple-system, "Hiragino Kaku Gothic ProN", "メイリオ", sans-serif; padding:18px; max-width:900px; margin:auto;}
  button{margin:6px 6px 6px 0; padding:10px 14px;}
  #preview{max-width:100%; border:1px solid #ccc; display:block; margin-top:10px;}
  #status{margin-top:10px; color:#333;}
  label.small{font-size:0.9em; color:#666; display:block; margin-top:6px;}
</style>
</head>
<body>
  <h2>画面共有 → スクショ → 送信</h2>

  <div>
    <button id="startShare">画面共有を開始</button>
    <button id="capture" disabled>スクショを撮る</button>
    <button id="send" disabled>サーバへ送信</button>
    <button id="stopShare" disabled>共有停止</button>
    <div class="small">※ ダイアログが出たら「画面/ウィンドウ/タブ」を選んで許可してください。</div>
  </div>

  <canvas id="canvas" style="display:none;"></canvas>
  <img id="preview" alt="スクショプレビュー" />

  <div id="status">状態: 待機中</div>

<script>
(function(){
  // ---- 設定: ここにあなたの GAS のデプロイ URL を入れてください ----
  const GAS_URL = "https://script.google.com/macros/s/AKfycbyRBCwvn_38oSCBlH-1ZTfOs4o_yh9yGjBpetfHCOogugyjn4HzyHTyA23mKwTZkh_x/exec";
  // -----------------------------------------------------------------

  const startBtn = document.getElementById('startShare');
  const captureBtn = document.getElementById('capture');
  const sendBtn = document.getElementById('send');
  const stopBtn = document.getElementById('stopShare');
  const previewImg = document.getElementById('preview');
  const canvas = document.getElementById('canvas');
  const status = document.getElementById('status');

  let stream = null;
  let videoTrack = null;
  let lastDataUrl = null; // base64 data URL

  function setStatus(text){
    status.textContent = "状態: " + text;
  }

  async function startShare(){
    try{
      stream = await navigator.mediaDevices.getDisplayMedia({video:true});
      // 拡張用途で video 要素を使う場合は作るが、ここでは canvas に直接描画する
      videoTrack = stream.getVideoTracks()[0];
      setStatus("画面共有中（準備OK）。スクショを撮ってください。");
      captureBtn.disabled = false;
      stopBtn.disabled = false;
      startBtn.disabled = true;

      // 自動的に最初のフレームをキャプチャする場合はここで呼ぶ
    } catch(err){
      console.error(err);
      setStatus("画面共有が開始できませんでした: " + err.message);
    }
  }

  function stopShare(){
    if(stream){
      stream.getTracks().forEach(t => t.stop());
      stream = null;
      videoTrack = null;
      startBtn.disabled = false;
      captureBtn.disabled = true;
      stopBtn.disabled = true;
      setStatus("共有停止しました。");
    }
  }

  async function captureScreenshot(){
    try {
      if(!stream){
        setStatus("まず画面共有を開始してください。");
        return;
      }

      // 一時的に <video> を作って currentFrame を描画する
      const v = document.createElement('video');
      v.srcObject = stream;
      v.muted = true;
      await v.play().catch(()=>{}); // 再生許可を待つ

      // canvas を映像サイズに合わせる
      canvas.width = v.videoWidth || 1280;
      canvas.height = v.videoHeight || 720;
      const ctx = canvas.getContext('2d');

      // 描画（遅延を入れると最新フレームを得やすい）
      await new Promise(r => setTimeout(r, 50));
      ctx.drawImage(v, 0, 0, canvas.width, canvas.height);

      // dataURL を取得
      const dataUrl = canvas.toDataURL('image/png'); // "data:image/png;base64,....."
      lastDataUrl = dataUrl;
      previewImg.src = dataUrl;
      previewImg.style.display = 'block';
      sendBtn.disabled = false;
      setStatus("スクショ取得完了。送信できます。");
      // stop the temporary video element
      v.pause();
      v.srcObject = null;
    } catch(err){
      console.error(err);
      setStatus("スクショ取得エラー: " + err.message);
    }
  }

  async function sendToServer(){
    if(!lastDataUrl){
      setStatus("送る画像がありません。スクショを撮ってください。");
      return;
    }
    setStatus("送信中...");

    try{
      // dataUrl から base64 部分のみを取り出す
      const base64 = lastDataUrl.split(',')[1];

      // ここではプリフライト回避を優先して Content-Type: text/plain にして送る
      const resp = await fetch(GAS_URL, {
        method: 'POST',
        // mode: 'cors', // 既定: cors。CORS 応答が無いとレスポンスは読み取れません
        headers: {
          'Content-Type': 'text/plain' // simple request にしてプリフライトを避ける
        },
        body: base64
      });

      // サーバが CORS を許可していればレスポンスを読めます
      let text = '';
      try {
        text = await resp.text();
      } catch(e) {
        // CORS ブロックなどで読むことができない場合
        text = '(サーバ応答を取得できませんでした — CORS 設定を要確認)';
      }

      setStatus("送信完了: " + text);
    } catch(err){
      console.error(err);
      setStatus("送信エラー: " + err.message + "（ネットワーク/CORS を確認）");
    }
  }

  startBtn.addEventListener('click', startShare);
  stopBtn.addEventListener('click', stopShare);
  captureBtn.addEventListener('click', captureScreenshot);
  sendBtn.addEventListener('click', sendToServer);

  // ウィンドウを閉じたときにトラックを停止
  window.addEventListener('beforeunload', ()=> {
    if(stream) stream.getTracks().forEach(t=>t.stop());
  });

})();
</script>
</body>
</html>
